name: Generate Badges

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  coverage-badge:
    name: Generate Coverage Badge
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: cargo tarpaulin --out Xml --all-features

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' cobertura.xml | head -1)
          COVERAGE_PERCENT=$(printf "%.0f" $(echo "$COVERAGE * 100" | bc))
          echo "percentage=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
          echo "Coverage: ${COVERAGE_PERCENT}%"

      - name: Create coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ secrets.GIST_ID }}
          filename: thoth-coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          valColorRange: ${{ steps.coverage.outputs.percentage }}
          maxColorRange: 100
          minColorRange: 0

  benchmark-badge:
    name: Generate Benchmark Badge
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Run benchmarks
        run: |
          cargo bench --bench file_loading -- --output-format bencher 2>&1 | tee benchmark_results.txt
          cargo bench --bench search -- --output-format bencher 2>&1 | tee -a benchmark_results.txt
          cargo bench --bench parsing -- --output-format bencher 2>&1 | tee -a benchmark_results.txt

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Rust Benchmarks
          tool: 'cargo'
          output-file-path: benchmark_results.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '150%'
          comment-on-alert: true
          fail-on-alert: false
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Create benchmark badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ secrets.GIST_ID }}
          filename: thoth-benchmarks.json
          label: benchmarks
          message: tracked
          color: blue
